<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Trustless AI Model Bounties – PVC Demo (3-vector)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121939;
      --muted: #a8b6d9;
      --text: #eaf1ff;
      --accent: #6cf0b6;
      --warn: #ffb86b;
      --danger: #ff6b6b;
      --ok: #35e0a1;
      --border: #26325c;
      --code: #0e1430;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(1300px 700px at 20% -10%, #1a2450 0%, #0b1020 60%, #0b1020 100%);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    header { padding: 20px 16px; border-bottom: 1px solid var(--border); position: sticky; top: 0; backdrop-filter: blur(6px); background: rgba(10,14,30,0.6); z-index: 10; }
    .container { max-width: 1100px; margin: 0 auto; padding: 0 16px 64px; }
    h1 { margin: 0; font-size: 22px; }
    h2 { margin: 18px 0 8px; font-size: 18px; }
    h3 { margin: 6px 0 8px; font-size: 16px; }
    p, .muted { color: var(--muted); }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .panel { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.0)); border: 1px solid var(--border); border-radius: 12px; padding: 14px; }
    .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 10px; }
    .col-3 { grid-column: span 3; } .col-4 { grid-column: span 4; } .col-6 { grid-column: span 6; } .col-8 { grid-column: span 8; } .col-12 { grid-column: span 12; }
    input, button { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #1f2b57; background: #0f1430; color: var(--text); outline: none; }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
    .btn { background: linear-gradient(180deg, #2b7d5d, #1a5a45); border: 1px solid #3ca378; cursor: pointer; font-weight: 600; }
    .btn.secondary { background: #192359; border-color: #2a3a77; }
    .btn.warn { background: #5a3a1a; border-color: #a36d3c; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .pill { display: inline-block; padding: 3px 8px; border: 1px solid #304080; background: #10183b; border-radius: 999px; font-size: 12px; }
    .tag { padding: 2px 8px; border: 1px solid #2a3a77; background: #121a3b; border-radius: 999px; font-size: 12px; display: inline-block; }
    .ok { color: var(--ok); } .danger { color: var(--danger); } .warn { color: var(--warn); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 6px; border-bottom: 1px solid #1b254a; font-size: 14px; }
    th { text-align: left; color: #cfe1ff; }
    .right { text-align: right; }
    .hr { height: 1px; background: var(--border); margin: 12px 0; }
    .code { background: var(--code); border: 1px solid var(--border); padding: 10px; border-radius: 8px; overflow-x: auto; white-space: pre; color: #d8e4ff; }
    .topbar { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .linkish { color: #b8cbff; cursor: pointer; text-decoration: underline; }
    .footer { margin-top: 24px; font-size: 12px; color: #9fb0d0; }

    /* Modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 999; }
    .modal { width: min(820px, 92vw); max-height: 90vh; overflow: auto; background: #101736; border: 1px solid #2a3a77; border-radius: 12px; padding: 16px; }
    .modal h3 { margin-top: 0; }
    .closebtn { float: right; cursor: pointer; font-weight: 700; color: #cfdaf9; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } .row { grid-template-columns: 1fr; } .col-3, .col-4, .col-6, .col-8, .col-12 { grid-column: span 1; } }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="topbar">
        <h1>Trustless AI Model Bounties – PVC (Demo)</h1>
        <span class="pill">Local-only UI (no blockchain)</span>
        <span class="linkish" onclick="openModal()">How does the PVC prove blending?</span>
      </div>
      <p class="muted">This demo walks through your exact 5-step flow with a toy homomorphic commitment. In production, swap in BN254 Pedersen vector commitments and your smart contract calls.</p>
    </div>
  </header>

  <div class="container">

    <!-- Step 1 -->
    <div class="panel">
      <h2>1) Create a contest</h2>
      <p class="muted">Provide only: Contest name, IPFS dataset, and a goal error rate (bps). Pool is fixed at 10,000 units for the demo.</p>
      <div class="row">
        <div class="col-6">
          <label>Contest name</label>
          <input id="contestName" placeholder="e.g. MNIST Classifier Challenge" />
        </div>
        <div class="col-6">
          <label>IPFS dataset (CID or URL)</label>
          <input id="datasetCid" placeholder="ipfs://..." />
        </div>
        <div class="col-6">
          <label>Goal error rate (bps)</label>
          <input id="goalBps" type="number" min="0" value="1000" />
        </div>
        <div class="col-6">
          <label>&nbsp;</label>
          <button class="btn" onclick="createContest()">Create Contest</button>
        </div>
      </div>
      <div class="hr"></div>
      <div id="contestInfo" class="muted"></div>
    </div>

    <!-- Step 2 and 3 -->
    <div class="grid">
      <div class="panel">
        <h2>2) Show dummy submissions</h2>
        <p class="muted">Click to populate a few sample models. Each submission has a 3-number vector, randomness r, error (bps), and a toy PVC commitment.</p>
        <button class="btn secondary" onclick="addDummy()">Add dummy submissions</button>
        <div class="hr"></div>
        <h3>Manual add (optional)</h3>
        <div class="row">
          <div class="col-4"><label>Participant</label><input id="pName" placeholder="alice" /></div>
          <div class="col-4"><label>Vector w (comma-separated)</label><input id="pVec" placeholder="12,-7,3" /></div>
          <div class="col-4"><label>r (uint)</label><input id="pR" type="number" value="123456789" /></div>
          <div class="col-4"><label>Error (bps)</label><input id="pErr" type="number" value="1500" /></div>
          <div class="col-8"><label>Model URI (optional)</label><input id="pUri" placeholder="ipfs://..." /></div>
          <div class="col-4"><label>&nbsp;</label><button class="btn" onclick="addManual()">Add submission</button></div>
        </div>
      </div>

      <div class="panel">
        <h2>3) See all submissions</h2>
        <p class="muted">Sorted by lowest error. Weight used in aggregation is num_i = 1 / (error_i + 1), integer division, so lower error gets higher weight.</p>
        <div id="subsTable"></div>
      </div>
    </div>

    <!-- Step 4 and 5 -->
    <div class="grid">
      <div class="panel">
        <h2>4) Federated average + PVC proof</h2>
        <p class="muted">Compute Wsum, Rsum, verify Commit(Wsum, Rsum) == Σ num_i · C_i, and show the averaged model.</p>
        <div class="row">
          <div class="col-8"><label>Aggregated model URI (optional)</label><input id="aggUri" placeholder="ipfs://final-model.json" /></div>
          <div class="col-4"><label>&nbsp;</label><button class="btn" onclick="aggregate()">Generate PVC proof</button></div>
        </div>
        <div class="hr"></div>
        <div id="aggOut"></div>
      </div>

      <div class="panel">
        <h2>5) Payout</h2>
        <p class="muted">Split the pool proportionally by num_i / Σ num_i. Requires a valid PVC aggregation first.</p>
        <button class="btn warn" onclick="payout()">Payout</button>
        <div class="hr"></div>
        <div id="payoutOut"></div>
      </div>
    </div>

    <div class="panel">
      <h3>Export proof artifact</h3>
      <p class="muted">Download a JSON containing submissions, weights, aggregated commitment, and the pass/fail check.</p>
      <button class="btn secondary" onclick="downloadArtifact()">Download JSON</button>
      <div class="hr"></div>
      <div id="artifactPreview" class="code mono" style="display:none;"></div>
    </div>

    <div class="footer">
      Cryptography note: This uses a toy linear commitment mod a prime to illustrate homomorphism. Replace with BN254 Pedersen vector commitments and your contract for a real demo.
    </div>
  </div>

  <!-- Modal: How PVC proves blending -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <span class="closebtn" onclick="closeModal()">✕</span>
      <h3>How PVC proves the blended proportions</h3>
      <p class="muted">
        Each participant commits to their model vector w_i = [w_i[0], w_i[1], w_i[2]] with randomness r_i using a Pedersen vector commitment:
      </p>
      <div class="code mono">
C_i = r_i · H + w_i[0] · G_0 + w_i[1] · G_1 + w_i[2] · G_2
      </div>
      <p class="muted">
        Suppose the payout weights are α_i (derived deterministically from error rates). Pedersen commitments are homomorphic:
      </p>
      <div class="code mono">
Σ α_i · C_i = (Σ α_i · r_i) · H + (Σ α_i · w_i[0]) · G_0 + (Σ α_i · w_i[1]) · G_1 + (Σ α_i · w_i[2]) · G_2
      </div>
      <p class="muted">
        If the aggregator publishes W_sum = Σ α_i · w_i and R_sum = Σ α_i · r_i, anyone can recompute Commit(W_sum, R_sum) and check it equals Σ α_i · C_i. That proves the final (blended) model was derived exactly from the committed inputs with the stated proportions α_i. We then use the same α_i to split the funds proportionally.
      </p>
      <p class="muted">
        In this UI, α_i are integers num_i = 1 / (error_i + 1). For presentation, you can also show the arithmetic average W_avg = W_sum / Σ num_i.
      </p>
    </div>
  </div>

  <script>
    // -----------------------------
    // Toy homomorphic commitment
    // C = r*H + w0*G0 + w1*G1 + w2*G2 (mod P)
    // -----------------------------
    const P  = BigInt("21888242871839275222246405745257275088548364400416034343698204186575808495617");
    const H  = 17293822569102704641n;
    const G0 = 3138551040899898973n;
    const G1 = 6277101735386680763n;
    const G2 = 957809713041180536473966891968943239761n;

    const state = {
      contest: null, // {name, datasetCid, goalBps, pool}
      subs: [],      // array of {id, name, w:[n,n,n], r, err, C}
      agg: null,     // {Wsum:[b,b,b], Rsum:b, nums:[n], sumNum:b, ok:bool, lhs:b, rhs:b, avg:[n,n,n]}
      paid: false
    };

    function toField(x) {
      let b = BigInt(x);
      b %= P; if (b < 0) b += P;
      return b;
    }

    function commitToy(w, r) {
      return (((toField(r)*H % P + toField(w[0])*G0 % P) % P + toField(w[1])*G1 % P) % P + toField(w[2])*G2 % P) % P;
    }

    function weightNumerator(errBps) {
      const denom = BigInt(errBps) + 1n; // eps = 1
      return 1000000000000n / denom;     // WEIGHT_BASE = 1e12
    }

    // Step 1
    function createContest() {
      const name = (document.getElementById('contestName').value || 'Demo Contest').trim();
      const datasetCid = (document.getElementById('datasetCid').value || 'ipfs://example').trim();
      const goalBps = Number(document.getElementById('goalBps').value || '1000');

      state.contest = { name, datasetCid, goalBps, pool: 10000n };
      state.subs = [];
      state.agg = null;
      state.paid = false;

      document.getElementById('contestInfo').innerHTML = `
        <div><span class="pill">Contest</span> <strong>${escapeHtml(name)}</strong></div>
        <div class="muted">Dataset: <span class="mono">${escapeHtml(datasetCid)}</span> | Goal error: <span class="mono">${goalBps} bps</span> | Pool: <span class="mono">${state.contest.pool.toString()}</span></div>
        <div class="muted">Weight rule: num_i = 1 / (error_i + 1); payout ∝ num_i / Σ num_i</div>
      `;
      renderSubs();
      document.getElementById('aggOut').innerHTML = '';
      document.getElementById('payoutOut').innerHTML = '';
      document.getElementById('artifactPreview').style.display = 'none';
    }

    // Step 2
    function addDummy() {
      ensureContest();
      const names = ['alice', 'bob', 'cara', 'dave', 'eva'];
      for (let i = 0; i < names.length; i++) {
        const w = [
          randInt(-10, 12),
          randInt(-10, 12),
          randInt(-10, 12)
        ];
        const r = randBig(1n, 10n**12n);
        const err = randInt(400, 6000); // bps
        pushSubmission(names[i], w, r, err, '');
      }
      renderSubs();
    }

    function addManual() {
      ensureContest();
      const name = (document.getElementById('pName').value || `user${state.subs.length+1}`).trim();
      const vecStr = (document.getElementById('pVec').value || '0,0,0').trim();
      const parts = vecStr.split(',').map(s => Number(s.trim()));
      if (parts.length !== 3 || parts.some(x => Number.isNaN(x))) { alert('Vector must be three comma-separated integers.'); return; }
      const r = BigInt(document.getElementById('pR').value || '0');
      const err = Number(document.getElementById('pErr').value || '1000');
      const uri = (document.getElementById('pUri').value || '').trim();
      pushSubmission(name, parts, r, err, uri);
      renderSubs();
    }

    function pushSubmission(name, w, r, err, uri) {
      const id = state.subs.length + 1;
      const C = commitToy(w, r);
      state.subs.push({ id, name, w, r, err, uri, C });
    }

    // Step 3
    function renderSubs() {
      const el = document.getElementById('subsTable');
      if (!state.contest) { el.innerHTML = '<span class="warn">Create a contest first.</span>'; return; }
      if (state.subs.length === 0) { el.innerHTML = '<span class="muted">No submissions yet. Add dummy submissions.</span>'; return; }

      const srt = [...state.subs].sort((a,b)=>a.err-b.err);
      let rows = srt.map(s => {
        const num = weightNumerator(s.err);
        const share = state.agg ? Number((num * 10000n) / state.agg.sumNum) / 100 : null;
        return `
          <tr>
            <td>#${s.id}</td>
            <td>${escapeHtml(s.name)}</td>
            <td class="mono">${s.w[0]}, ${s.w[1]}, ${s.w[2]}</td>
            <td class="right mono">${s.r.toString()}</td>
            <td class="right mono">${s.err}</td>
            <td class="right mono">${num.toString()}</td>
            <td class="mono">${"0x"+s.C.toString(16).slice(0,10)}…</td>
            <td>${s.uri ? `<a href="${escapeAttr(s.uri)}" target="_blank">link</a>` : '-'}</td>
            <td class="right">${state.agg ? `${share.toFixed(2)}%` : '-'}</td>
          </tr>`;
      }).join('');

      el.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>ID</th><th>Participant</th><th>Vector w</th><th class="right">r</th><th class="right">Error (bps)</th><th class="right">num_i</th><th>Commit (toy)</th><th>URI</th><th class="right">Share</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    // Step 4
    function aggregate() {
      ensureContest();
      if (state.subs.length === 0) { alert('No submissions.'); return; }

      let Wsum = [0n,0n,0n], Rsum = 0n, nums = [], sumNum = 0n;
      for (const s of state.subs) {
        const num = weightNumerator(s.err);
        nums.push(Number(num));
        sumNum += num;

        Wsum[0] = (Wsum[0] + num * toField(s.w[0])) % P;
        Wsum[1] = (Wsum[1] + num * toField(s.w[1])) % P;
        Wsum[2] = (Wsum[2] + num * toField(s.w[2])) % P;
        Rsum    = (Rsum    + num * toField(s.r)) % P;
      }
      if (sumNum === 0n) { alert('Sum of weights is zero.'); return; }

      const lhs = commitToy(Wsum, Rsum);
      let rhs = 0n;
      for (let i=0;i<state.subs.length;i++) {
        rhs = (rhs + BigInt(nums[i]) * state.subs[i].C) % P;
      }
      const ok = (lhs === rhs);

      const avg = [Number(Wsum[0]/sumNum), Number(Wsum[1]/sumNum), Number(Wsum[2]/sumNum)];
      state.agg = { Wsum, Rsum, nums, sumNum, ok, lhs, rhs, avg, aggUri: (document.getElementById('aggUri').value || '') };
      renderAgg();
      renderSubs();
      renderArtifactPreview();
    }

    function renderAgg() {
      const a = state.agg;
      if (!a) { document.getElementById('aggOut').innerHTML=''; return; }
      const okText = a.ok ? `<span class="ok">PVC check passed</span>` : `<span class="danger">PVC check failed</span>`;
      const numsList = state.subs.map((s,i)=>`#${s.id}:${a.nums[i]}`).join(', ');
      const html = `
        <div class="tag">Proof</div>
        <div class="mono">Check: Commit(Wsum, Rsum) == Σ num_i · C_i → ${okText}</div>
        <div class="hr"></div>
        <div class="mono">Wsum: [${a.Wsum[0]}, ${a.Wsum[1]}, ${a.Wsum[2]}]</div>
        <div class="mono">Rsum: ${a.Rsum}</div>
        <div class="mono">Σ num_i = ${a.sumNum.toString()}</div>
        <div class="mono">nums: ${numsList}</div>
        <div class="hr"></div>
        <div><span class="tag">Averaged model (display)</span> <span class="mono">[${a.avg[0]}, ${a.avg[1]}, ${a.avg[2]}]</span></div>
        ${a.aggUri ? `<div class="muted">Aggregated model URI: <span class="mono">${escapeHtml(a.aggUri)}</span></div>` : ''}
      `;
      document.getElementById('aggOut').innerHTML = html;
    }

    // Step 5
    function payout() {
      ensureContest();
      if (!state.agg || !state.agg.ok) { alert('Run aggregation and ensure PVC check passes first.'); return; }
      if (state.paid) { alert('Already paid.'); return; }

      const pool = state.contest.pool;
      const payouts = state.subs.map((s,i) => {
        const num = BigInt(state.agg.nums[i]);
        const amt = (pool * num) / state.agg.sumNum;
        return { id: s.id, name: s.name, amount: amt };
      });

      state.paid = true;

      const rows = payouts.map(p => `<tr><td>#${p.id}</td><td>${escapeHtml(p.name)}</td><td class="right mono">${p.amount.toString()}</td></tr>`).join('');
      document.getElementById('payoutOut').innerHTML = `
        <div class="ok">Payouts computed and (simulated) sent.</div>
        <table><thead><tr><th>ID</th><th>Participant</th><th class="right">Amount</th></tr></thead><tbody>${rows}</tbody></table>
      `;
    }

    // Artifact JSON
    function buildArtifact() {
      if (!state.contest || !state.agg) return null;
      return {
        ciphersuite: "Toy-Linear-Commitment-v0 (demo only)",
        primeP: P.toString(),
        generators: { H: H.toString(), G0: G0.toString(), G1: G1.toString(), G2: G2.toString() },
        contest: {
          name: state.contest.name,
          datasetCid: state.contest.datasetCid,
          goalBps: state.contest.goalBps,
          pool: state.contest.pool.toString(),
          weightRule: "num_i = floor(1e12 / (error_i + 1))"
        },
        submissions: state.subs.map(s => ({
          id: s.id, name: s.name, w: s.w, r: s.r.toString(), errorBps: s.err, C: s.C.toString(), uri: s.uri || ""
        })),
        aggregation: {
          nums: state.agg.nums,
          sumNum: state.agg.sumNum.toString(),
          Wsum: state.agg.Wsum.map(x => x.toString()),
          Rsum: state.agg.Rsum.toString(),
          lhs: state.agg.lhs.toString(),
          rhs: state.agg.rhs.toString(),
          ok: state.agg.ok,
          avg: state.agg.avg,
          aggregatedModelUri: state.agg.aggUri
        }
      };
    }

    function renderArtifactPreview() {
      const art = buildArtifact();
      const el = document.getElementById('artifactPreview');
      if (!art) { el.style.display='none'; return; }
      el.style.display='block';
      el.textContent = JSON.stringify(art, null, 2);
    }

    function downloadArtifact() {
      const art = buildArtifact();
      if (!art) { alert('Nothing to export yet. Run aggregation first.'); return; }
      const blob = new Blob([JSON.stringify(art, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'pvc_proof_artifact.json'; a.click();
      URL.revokeObjectURL(url);
    }

    // Modal controls
    function openModal(){ document.getElementById('modalBackdrop').style.display = 'flex'; }
    function closeModal(){ document.getElementById('modalBackdrop').style.display = 'none'; }

    // Utils
    function ensureContest(){ if (!state.contest) throw alert('Create a contest first.'); }
    function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    function randBig(min,max){ const span = max-min+1n; const r = BigInt(Math.floor(Math.random()*1e9)); return min + (r % span); }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function escapeAttr(s){ return escapeHtml(s); }

    // Bootstrap default contest
    createContest();
  </script>
</body>
</html>
